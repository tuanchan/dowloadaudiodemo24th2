name: ğŸ Build iOS IPA (Unsigned)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (leave empty for auto)'
        required: false
        default: ''

env:
  FLUTTER_VERSION: '3.19.0'
  XCODE_VERSION: '15.2'

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      # â”€â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # â”€â”€â”€ Setup Flutter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      # â”€â”€â”€ Setup Xcode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ› ï¸ Select Xcode Version
        run: |
          sudo xcode-select -switch /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
          xcodebuild -version

      # â”€â”€â”€ Cache CocoaPods â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # â”€â”€â”€ Flutter Dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install Flutter Dependencies
        run: |
          flutter --version
          flutter pub get

      # â”€â”€â”€ iOS Dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Install iOS Dependencies (CocoaPods)
        working-directory: ios
        run: |
          pod install --repo-update

      # â”€â”€â”€ Increment Build Number â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”¢ Set Build Number
        run: |
          BUILD_NUM="${{ github.event.inputs.build_number }}"
          if [ -z "$BUILD_NUM" ]; then
            BUILD_NUM="${{ github.run_number }}"
          fi
          echo "BUILD_NUMBER=$BUILD_NUM" >> $GITHUB_ENV
          echo "Using build number: $BUILD_NUM"

      # â”€â”€â”€ Build iOS (No Code Sign) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Build iOS App (No Code Signing)
        run: |
          flutter build ios \
            --release \
            --no-codesign \
            --build-number=${{ env.BUILD_NUMBER }}

      # â”€â”€â”€ Create Payload & IPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Package as IPA
        run: |
          # Create directory structure
          mkdir -p Payload
          
          # Copy .app bundle
          APP_PATH=$(find build/ios/iphoneos -name "*.app" | head -1)
          echo "Found app at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          
          # Create IPA (IPA = zip with Payload folder)
          zip -r YTDownloader.ipa Payload/
          
          # Verify
          ls -lh YTDownloader.ipa
          echo "âœ… IPA created successfully!"

      # â”€â”€â”€ Upload IPA Artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â˜ï¸ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YTDownloader-iOS-${{ env.BUILD_NUMBER }}
          path: YTDownloader.ipa
          retention-days: 30
          if-no-files-found: error

      # â”€â”€â”€ Create Release (on tag) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: YTDownloader.ipa
          name: YT Downloader ${{ github.ref_name }}
          body: |
            ## ğŸ“± YT Downloader ${{ github.ref_name }}
            
            ### CÃ i Ä‘áº·t (Sideload - khÃ´ng cáº§n jailbreak):
            
            #### ğŸ”§ DÃ¹ng Sideloadly:
            1. Táº£i [Sideloadly](https://sideloadly.io/) vá» mÃ¡y tÃ­nh
            2. Káº¿t ná»‘i iPhone/iPad qua USB
            3. KÃ©o file `YTDownloader.ipa` vÃ o Sideloadly
            4. Nháº­p Apple ID (dÃ¹ng tÃ i khoáº£n phá»¥)
            5. Nháº¥n **Start** vÃ  chá» cÃ i Ä‘áº·t
            6. VÃ o **Settings > General > VPN & Device Management** vÃ  **Trust** developer
            
            #### ğŸ“² DÃ¹ng eSign (khÃ´ng cáº§n mÃ¡y tÃ­nh):
            1. CÃ i eSign tá»«: `esign.yyyue.xyz`
            2. Táº£i file IPA vá» trong eSign
            3. Import certificate vÃ o eSign
            4. KÃ½ vÃ  cÃ i Ä‘áº·t
            
            > âš ï¸ App cÃ³ hiá»‡u lá»±c **7 ngÃ y** vá»›i tÃ i khoáº£n Apple ID miá»…n phÃ­.
            > DÃ¹ng Apple Developer Account ($99/nÄƒm) Ä‘á»ƒ cÃ³ hiá»‡u lá»±c **1 nÄƒm**.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ Build Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: ğŸ“Š Build Summary
    needs: build-ios
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Print Summary
        run: |
          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "âœ… iOS build SUCCEEDED!"
            echo "ğŸ“¦ IPA artifact available for download in GitHub Actions"
          else
            echo "âŒ iOS build FAILED!"
            exit 1
          fi
