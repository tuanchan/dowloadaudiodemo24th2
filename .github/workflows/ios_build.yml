name: ğŸ Build iOS IPA (Unsigned)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (leave empty for auto)'
        required: false
        default: ''

env:
  FLUTTER_VERSION: '3.19.0'
  XCODE_VERSION: '15.2'   # sáº½ Ä‘Æ°á»£c setup-xcode chá»n Ä‘Ãºng

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # --- Setup Xcode (FIX CHÃNH) ---
      - name: ğŸ› ï¸ Setup Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: âœ… Xcode version
        run: |
          xcode-select -p
          xcodebuild -version

      # --- Setup Flutter ---
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      # --- Cache CocoaPods ---
      - name: ğŸ“¦ Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # --- Flutter deps ---
      - name: ğŸ“¦ Install Flutter Dependencies
        run: |
          flutter --version
          flutter pub get

      # --- iOS Pods ---
      - name: ğŸ“¦ Install iOS Dependencies (CocoaPods)
        working-directory: ios
        run: |
          pod repo update
          pod install

      # --- Build number ---
      - name: ğŸ”¢ Set Build Number
        shell: bash
        run: |
          BUILD_NUM="${{ github.event.inputs.build_number }}"
          if [ -z "$BUILD_NUM" ]; then
            BUILD_NUM="${{ github.run_number }}"
          fi
          echo "BUILD_NUMBER=$BUILD_NUM" >> $GITHUB_ENV
          echo "Using build number: $BUILD_NUM"

      # --- Build iOS no codesign ---
      - name: ğŸ—ï¸ Build iOS App (No Code Signing)
        shell: bash
        run: |
          flutter build ios \
            --release \
            --no-codesign \
            --build-number="${BUILD_NUMBER}"

      # --- Package IPA ---
      - name: ğŸ“¦ Package as IPA
        shell: bash
        run: |
          rm -rf Payload YTDownloader.ipa
          mkdir -p Payload

          APP_PATH="$(find build/ios/iphoneos -maxdepth 2 -name '*.app' | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Cannot find .app in build/ios/iphoneos"
            find build/ios -maxdepth 4 -type d -print
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          cp -R "$APP_PATH" Payload/

          /usr/bin/zip -r YTDownloader.ipa Payload >/dev/null
          ls -lh YTDownloader.ipa
          echo "âœ… IPA created successfully!"

      # --- Upload artifact ---
      - name: â˜ï¸ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YTDownloader-iOS-${{ env.BUILD_NUMBER }}
          path: YTDownloader.ipa
          retention-days: 30
          if-no-files-found: error

      # --- Release on tag ---
      - name: ğŸš€ Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: YTDownloader.ipa
          name: YT Downloader ${{ github.ref_name }}
          body: |
            ## ğŸ“± YT Downloader ${{ github.ref_name }}

            ### CÃ i Ä‘áº·t (Sideload - khÃ´ng cáº§n jailbreak)

            #### ğŸ”§ DÃ¹ng Sideloadly:
            1. Táº£i Sideloadly vá» mÃ¡y tÃ­nh
            2. Káº¿t ná»‘i iPhone/iPad qua USB
            3. KÃ©o file `YTDownloader.ipa` vÃ o Sideloadly
            4. Nháº­p Apple ID (dÃ¹ng tÃ i khoáº£n phá»¥)
            5. Nháº¥n **Start** vÃ  chá» cÃ i Ä‘áº·t
            6. VÃ o **Settings > General > VPN & Device Management** vÃ  **Trust** developer

            > âš ï¸ App cÃ³ hiá»‡u lá»±c **7 ngÃ y** vá»›i Apple ID miá»…n phÃ­.
            > DÃ¹ng Apple Developer Account Ä‘á»ƒ cÃ³ hiá»‡u lá»±c lÃ¢u hÆ¡n.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: ğŸ“Š Build Summary
    needs: build-ios
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Print Summary
        run: |
          if [ "${{ needs.build-ios.result }}" = "success" ]; then
            echo "âœ… iOS build SUCCEEDED!"
            echo "ğŸ“¦ IPA artifact available for download in GitHub Actions"
          else
            echo "âŒ iOS build FAILED!"
            exit 1
          fi