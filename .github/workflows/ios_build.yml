name: ðŸŽ Build iOS IPA (Unsigned)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.22.3"
  IPA_NAME: "ytdlp_downloader-unsigned"

jobs:
  build-ios-unsigned:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Show versions
        run: |
          flutter --version
          dart --version
          xcodebuild -version

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install iOS Dependencies (CocoaPods)
        working-directory: ios
        run: |
          pod repo update
          pod install

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Package unsigned IPA
        shell: bash
        run: |
          set -e
          rm -rf Payload "build/${IPA_NAME}.ipa"
          mkdir -p Payload

          APP_PATH="$(find build/ios/iphoneos -maxdepth 2 -name '*.app' | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Cannot find .app in build/ios/iphoneos"
            find build/ios -maxdepth 4 -type d -print
            exit 1
          fi

          echo "âœ… Found app: $APP_PATH"
          cp -R "$APP_PATH" Payload/

          /usr/bin/zip -r "build/${IPA_NAME}.ipa" Payload >/dev/null
          ls -lh "build/${IPA_NAME}.ipa"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IPA_NAME }}-${{ github.run_number }}
          path: build/${{ env.IPA_NAME }}.ipa
          if-no-files-found: error
          retention-days: 30